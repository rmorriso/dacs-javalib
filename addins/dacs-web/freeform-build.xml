<?xml version='1.0'?>
<project name="dacs-web" default="war" basedir=".">

  <description>Builds, tests, and runs the project dacs-web.</description>

  <!-- set local/global properties for this build -->
 
  <property file="./freeform.properties"/>
  <property file="../project.properties"/>

  <property name="include" value="${root.dir}/lib"/>
  <property name="dacs-version" value="1.4.x"/>

  <target name="init" depends="-init-check">
    <!-- Create the build directory structure used by compile -->
    <mkdir dir="${build.dir}" />
    <!-- Create the directory for the jar file -->
    <mkdir dir="${dist.dir}" />
    <!-- Create the directory for the java docs -->
    <mkdir dir="${dist.javadoc.dir}" />
  </target>

  <target name="compile" depends="init">
    <!-- copy all .java files from ${j2ee.src.dir} to ${build.classes.dir}  -->
    <copy todir="${build.classes.dir}/">
      <fileset dir="${j2ee.src.dir}" includes="**/*.java **/*.properties"/>
    </copy>
    <!-- run javac to compile the source files -->
    <javac srcdir="${j2ee.src.dir}" destdir="${build.classes.dir}">
      <classpath>
        <!-- use value of ${javac.classpath} property in the classpath -->
        <pathelement path="${javac.classpath}"/>
        <!-- include all jar files  -->
        <fileset dir="${include}">
           <include name="**/*.jar"/>
        </fileset>
      </classpath>
    </javac>
  </target>

  <target name="compile-test" depends="init,compile">
    <!-- copy all .java files from ${test.src.dir} to ${build.test.classes.dir}  -->
    <copy todir="${build.test.classes.dir}/">
      <fileset dir="${test.src.dir}" includes="**/*.java"/>
    </copy>
    <!-- run javac to compile the source files -->
    <javac srcdir="${test.src.dir}" destdir="${build.test.classes.dir}">
      <classpath>
        <!-- use value of ${javac.test.classpath} property in the classpath -->
        <pathelement path="${javac.test.classpath}"/>
        <!-- include all jar files  -->
        <fileset dir="${include}">
           <include name="**/*.jar"/>
        </fileset>
      </classpath>
    </javac>
  </target>

  <target name="war" depends="compile">
    <war destfile="${dist.war}" webxml="${web.dir}/WEB-INF/web.xml">
      <fileset dir="${web.dir}"/>
      <lib dir="${include}">
        <exclude name="jsp-api.jar"/>
        <exclude name="servlet-api.jar"/>
      </lib>
      <lib file="${root.dir}/dacs-client/dist/dacs-client.jar"/>
      <lib file="${root.dir}/dacs-services/dist/dacs-services.jar"/>
      <lib file="${root.dir}/dacs-xmlbeans/lib/dacs-xmlbeans.jar"/>
      <lib file="${root.dir}/fedutil/dist/fedutil.jar"/>
      <classes dir="${build.classes.dir}"/>
    </war> 
  </target>

  <target name="test" depends="compile-test">
    <mkdir dir="${build.test.results.dir}" />

    <junit printsummary="yes" haltonfailure="yes">
      <classpath>
        <pathelement location="${build.test.classes.dir}"/>
        <pathelement path="${javac.test.classpath}"/>
      </classpath>

      <formatter type="plain"/>

      <batchtest fork="yes" todir="${build.test.results.dir}">
        <fileset dir="${test.src.dir}">
          <include name="**/*Test*.java"/>
          <exclude name="**/AllTests.java"/>
        </fileset>
      </batchtest>
    </junit>
  </target>

  <target name="javadocs" depends="compile">
    <!-- create javadocs -->
    <javadoc destdir="${dist.javadoc.dir}"
           author="true"
           version="true"
           use="true">
      <classpath>
        <path path="${javac.classpath}"/>
      </classpath>
      <sourcepath>
        <pathelement location="${j2ee.src.dir}"/>
      </sourcepath>
      <fileset dir="${j2ee.src.dir}" defaultexcludes="yes">
        <include name="**/*.java"/>
      </fileset>
      <doctitle>
        <![CDATA[<h1>DACS Java Library ${dacs-javalib-version}: dacs-web</h1>]]>
      </doctitle>
      <bottom>
        <![CDATA[<i>Copyright &#169; 2005-2006 Metalogic Software Corporation All Rights Reserved.</i>]]>
      </bottom>
    </javadoc>
  </target>

  <target name="clean">
    <!-- Delete the ${build.dir} and ${dist.dir} directory trees -->
    <delete dir="${build.dir}"/>
    <delete dir="${dist.dir}"/>
  </target>

  <target name="-init-check">
    <fail unless="j2ee.src.dir">Must set src.dir</fail>
    <fail unless="test.src.dir">Must set test.src.dir</fail>
    <fail unless="build.dir">Must set build.dir</fail>
    <fail unless="dist.dir">Must set dist.dir</fail>
    <fail unless="build.classes.dir">Must set build.classes.dir</fail>
    <fail unless="dist.javadoc.dir">Must set dist.javadoc.dir</fail>
    <fail unless="build.test.classes.dir">Must set build.test.classes.dir</fail>
    <fail unless="build.test.results.dir">Must set build.test.results.dir</fail>
    <fail unless="build.classes.excludes">Must set build.classes.excludes</fail>
    <fail unless="dist.war">Must set dist.war</fail>
  </target>

</project>

